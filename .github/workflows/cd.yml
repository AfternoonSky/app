# the VM hosting the deployed app only has IPv6, which github does not support
# so our CD pushes to a GitLab mirror of the repository, and hits a webhook on the VM

name: GitLab Mirror

on:
    workflow_dispatch:
# not yet working
#   push:
    # branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - name: Install Dependencies
        run: npm ci
      - name: Build
        run: npm run build

  mirror:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure Git for GitLab
        run: |
            git config --global user.email "git@pmsky.social"
            git config --global user.name "PMsky's GitHub Actions Runner"
            # Add the GitLab remote; replace with your GitLab repo URL
            git remote add gitlab https://oauth2:${{ secrets.GITLAB_TOKEN }}@gitlab.com/afternoonsky/app.git || true

      - name: Push to GitLab
        run: git push gitlab main 
